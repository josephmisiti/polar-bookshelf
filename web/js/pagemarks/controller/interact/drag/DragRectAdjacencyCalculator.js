"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Rects_1 = require("../../../../Rects");
const LineAdjustment_1 = require("./LineAdjustment");
const Line_1 = require("../../../../util/Line");
const Adjacency_1 = require("./Adjacency");
const Preconditions_1 = require("../../../../Preconditions");
class DragRectAdjacencyCalculator {
    static calculate(primaryRect, secondaryRect, restrictionRect) {
        Preconditions_1.Preconditions.assertPresent(primaryRect, "primaryRect");
        Preconditions_1.Preconditions.assertPresent(secondaryRect, "secondaryRect");
        const result = new Adjacency_1.Adjacency();
        if (!restrictionRect) {
            restrictionRect = Rects_1.Rects.createFromBasicRect({
                left: -1000000,
                top: -1000000,
                bottom: 1000000,
                right: 1000000
            });
        }
        result.primaryRect = Rects_1.Rects.validate(primaryRect);
        result.secondaryRect = Rects_1.Rects.validate(secondaryRect);
        const secondaryBox = {
            horizontal: new Line_1.Line(secondaryRect.left, secondaryRect.right),
            vertical: new Line_1.Line(secondaryRect.top, secondaryRect.bottom)
        };
        const primaryBox = {
            horizontal: new Line_1.Line(primaryRect.left, primaryRect.right),
            vertical: new Line_1.Line(primaryRect.top, primaryRect.bottom)
        };
        const restrictionBox = {
            horizontal: new Line_1.Line(restrictionRect.left, restrictionRect.right),
            vertical: new Line_1.Line(restrictionRect.top, restrictionRect.bottom)
        };
        Preconditions_1.Preconditions.assertPresent(primaryBox, "primaryBox");
        Preconditions_1.Preconditions.assertPresent(secondaryBox, "secondaryBox");
        Preconditions_1.Preconditions.assertPresent(restrictionBox, "restrictionBox");
        result.adjustments.horizontal
            = DragRectAdjacencyCalculator.adjust(primaryBox.horizontal, secondaryBox.horizontal, restrictionBox.horizontal, "x");
        result.adjustments.vertical
            = DragRectAdjacencyCalculator.adjust(primaryBox.vertical, secondaryBox.vertical, restrictionBox.vertical, "y");
        let successfulAdjustments = [result.adjustments.horizontal, result.adjustments.vertical];
        successfulAdjustments = successfulAdjustments.filter(current => current.overlapped === true);
        successfulAdjustments = successfulAdjustments.sort((adj0, adj1) => adj0.delta - adj1.delta);
        if (successfulAdjustments.length >= 1) {
            result.adjustment = successfulAdjustments[0];
            result.adjustedRect = result.adjustment.adjustRect(primaryRect);
        }
        return result;
    }
    static adjust(primaryLine, secondaryLine, restrictionLine, axis) {
        const none = new LineAdjustment_1.LineAdjustment({
            axis,
            overlapped: false,
            start: primaryLine.start,
            snapped: null
        });
        let result = none;
        if (secondaryLine.overlaps(primaryLine) || primaryLine.overlaps(secondaryLine)) {
            let results = [];
            results.push(LineAdjustment_1.LineAdjustment.create({
                axis,
                start: secondaryLine.end,
                previous: primaryLine.start,
                snapped: "AFTER"
            }));
            results.push(LineAdjustment_1.LineAdjustment.create({
                axis,
                start: secondaryLine.start - primaryLine.width,
                previous: primaryLine.start,
                snapped: "BEFORE"
            }));
            results = results.filter(result => {
                if (result.start < restrictionLine.start) {
                    return false;
                }
                if ((result.start + primaryLine.width) > restrictionLine.end) {
                    return false;
                }
                return true;
            });
            results = results.sort((r0, r1) => r0.delta - r1.delta);
            if (results.length > 0) {
                result = results[0];
            }
        }
        return result;
    }
}
exports.DragRectAdjacencyCalculator = DragRectAdjacencyCalculator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRHJhZ1JlY3RBZGphY2VuY3lDYWxjdWxhdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiRHJhZ1JlY3RBZGphY2VuY3lDYWxjdWxhdG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQ0EsNkNBQXdDO0FBQ3hDLHFEQUFnRDtBQUNoRCxnREFBMkM7QUFDM0MsMkNBQXNDO0FBQ3RDLDZEQUF3RDtBQU14RCxNQUFhLDJCQUEyQjtJQWU3QixNQUFNLENBQUMsU0FBUyxDQUFDLFdBQWlCLEVBQUUsYUFBbUIsRUFBRSxlQUFzQjtRQUVsRiw2QkFBYSxDQUFDLGFBQWEsQ0FBQyxXQUFXLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFDeEQsNkJBQWEsQ0FBQyxhQUFhLENBQUMsYUFBYSxFQUFFLGVBQWUsQ0FBQyxDQUFDO1FBRTVELE1BQU0sTUFBTSxHQUFHLElBQUkscUJBQVMsRUFBRSxDQUFDO1FBRS9CLElBQUksQ0FBQyxlQUFlLEVBQUU7WUFNbEIsZUFBZSxHQUFHLGFBQUssQ0FBQyxtQkFBbUIsQ0FBQztnQkFDeEMsSUFBSSxFQUFFLENBQUMsT0FBTztnQkFDZCxHQUFHLEVBQUUsQ0FBQyxPQUFPO2dCQUNiLE1BQU0sRUFBRSxPQUFPO2dCQUNmLEtBQUssRUFBRSxPQUFPO2FBQ2pCLENBQUMsQ0FBQztTQUVOO1FBRUQsTUFBTSxDQUFDLFdBQVcsR0FBRyxhQUFLLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ2pELE1BQU0sQ0FBQyxhQUFhLEdBQUcsYUFBSyxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUVyRCxNQUFNLFlBQVksR0FBRztZQUNqQixVQUFVLEVBQUUsSUFBSSxXQUFJLENBQUMsYUFBYSxDQUFDLElBQUksRUFBRSxhQUFhLENBQUMsS0FBSyxDQUFDO1lBQzdELFFBQVEsRUFBRSxJQUFJLFdBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxFQUFFLGFBQWEsQ0FBQyxNQUFNLENBQUM7U0FDOUQsQ0FBQztRQUVG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QUFJLENBQUMsK0JBQWMsQ0FBQyxNQUFNLENBQUM7Z0JBQy9CLElBQUk7Z0JBQ0osS0FBSyxFQUFFLGFBQWEsQ0FBQyxLQUFLLEdBQUcsV0FBVyxDQUFDLEtBQUs7Z0JBQzlDLFFBQVEsRUFBRSxXQUFXLENBQUMsS0FBSztnQkFDM0IsT0FBTyxFQUFFLFFBQVE7YUFDcEIsQ0FBQyxDQUFDLENBQUM7WUFJSixPQUFPLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBRSxNQUFNLENBQUMsRUFBRTtnQkFFL0IsSUFBSSxNQUFNLENBQUMsS0FBSyxHQUFHLGVBQWUsQ0FBQyxLQUFLLEVBQUU7b0JBQ3RDLE9BQU8sS0FBSyxDQUFDO2lCQUNoQjtnQkFFRCxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsZUFBZSxDQUFDLEdBQUcsRUFBRTtvQkFDMUQsT0FBTyxLQUFLLENBQUM7aUJBQ2hCO2dCQUVELE9BQU8sSUFBSSxDQUFDO1lBRWhCLENBQUMsQ0FBQyxDQUFDO1lBRUgsT0FBTyxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUt4RCxJQUFJLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFHO2dCQUNyQixNQUFNLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ3ZCO1NBRUo7UUFLRCxPQUFPLE1BQU0sQ0FBQztJQUVsQixDQUFDO0NBRUo7QUExSkQsa0VBMEpDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtSZWN0fSBmcm9tIFwiLi4vLi4vLi4vLi4vUmVjdFwiO1xuaW1wb3J0IHtSZWN0c30gZnJvbSBcIi4uLy4uLy4uLy4uL1JlY3RzXCI7XG5pbXBvcnQge0xpbmVBZGp1c3RtZW50fSBmcm9tIFwiLi9MaW5lQWRqdXN0bWVudFwiO1xuaW1wb3J0IHtMaW5lfSBmcm9tIFwiLi4vLi4vLi4vLi4vdXRpbC9MaW5lXCI7XG5pbXBvcnQge0FkamFjZW5jeX0gZnJvbSBcIi4vQWRqYWNlbmN5XCI7XG5pbXBvcnQge1ByZWNvbmRpdGlvbnN9IGZyb20gJy4uLy4uLy4uLy4uL1ByZWNvbmRpdGlvbnMnO1xuXG4vKipcbiAqIElmIHdlIGhhdmUgdHdvIHJlY3RzLCBhbmQgdGhlJ3ZlIG1vdmVkIHRvIGludGVyc2VjdCwgY29tcHV0ZSB1cGRhdGVkXG4gKiBwb3NpdGlvbnMgc28gdGhhdCB0aGV5IGFyZSBBREpBQ0VOVCwgbm90IGludGVyc2VjdGluZy5cbiAqL1xuZXhwb3J0IGNsYXNzIERyYWdSZWN0QWRqYWNlbmN5Q2FsY3VsYXRvciB7XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqIEBwYXJhbSBwcmltYXJ5UmVjdCB7UmVjdH0gVGhlIHByaW1hcnkgcmVjdCB0aGF0IGlzIG1vdmluZyBhbmQgaXNcbiAgICAgKiAgICAgaW50ZXJzZWN0aW5nIHdpdGggdGhlIHNlY29uZGFyeSByZWN0LiAgVGhlIHByaW1hcnkgcmVjdCBpcyB0aGUgb25lXG4gICAgICogICAgIHdlIHdhbnQgdG8gYWRqdXN0LlxuICAgICAqXG4gICAgICogQHBhcmFtIHNlY29uZGFyeVJlY3Qge1JlY3R9IFRoZSBzdGF0aW9uYXJ5IHJlY3QgdGhhdCB3ZSBuZWVkIHRvIGtlZXAgb3VyXG4gICAgICogICAgIHJlY3QgYWRqYWNlbnQgdG9vLlxuICAgICAqIEBwYXJhbSBbcmVzdHJpY3Rpb25SZWN0XSB7UmVjdH0gTGltaXQgdGhlIG1vdmVtZW50IHRvIHRoZSBnaXZlbiByZWN0LlxuICAgICAqXG4gICAgICogQHJldHVybiB7QWRqYWNlbmN5fSBSZXR1cm4gdGhlIG5ldyAvIGNvcnJlY3QgcG9zaXRpb24gb2YgdGhlIHByaW1hcnlcbiAgICAgKiAgICAgcmVjdC5cbiAgICAgKi9cbiAgICBwdWJsaWMgc3RhdGljIGNhbGN1bGF0ZShwcmltYXJ5UmVjdDogUmVjdCwgc2Vjb25kYXJ5UmVjdDogUmVjdCwgcmVzdHJpY3Rpb25SZWN0PzogUmVjdCkge1xuXG4gICAgICAgIFByZWNvbmRpdGlvbnMuYXNzZXJ0UHJlc2VudChwcmltYXJ5UmVjdCwgXCJwcmltYXJ5UmVjdFwiKTtcbiAgICAgICAgUHJlY29uZGl0aW9ucy5hc3NlcnRQcmVzZW50KHNlY29uZGFyeVJlY3QsIFwic2Vjb25kYXJ5UmVjdFwiKTtcblxuICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgQWRqYWNlbmN5KCk7XG5cbiAgICAgICAgaWYgKCFyZXN0cmljdGlvblJlY3QpIHtcblxuICAgICAgICAgICAgLy8gZGVmaW5lIGEgSFVHRSByZWN0IHRvIHdvcmsgd2l0aGluIGJ5IGRlZmF1bHQuICBNYXRoZW1hdGljYWxseSwgd2VcbiAgICAgICAgICAgIC8vIHNob3VsZCBwcm9iYWJseSB1c2UgaW5maW5pdHkgYW5kIG5lZ2F0aXZlIGluZmluaXR5IGJ1dCB3b3JraW5nXG4gICAgICAgICAgICAvLyB3aXRoIHRoZXNlIGluIEphdmFzY3JpcHQgKyBKU09OIGlzIGxpbWl0ZWQuXG5cbiAgICAgICAgICAgIHJlc3RyaWN0aW9uUmVjdCA9IFJlY3RzLmNyZWF0ZUZyb21CYXNpY1JlY3Qoe1xuICAgICAgICAgICAgICAgIGxlZnQ6IC0xMDAwMDAwLFxuICAgICAgICAgICAgICAgIHRvcDogLTEwMDAwMDAsXG4gICAgICAgICAgICAgICAgYm90dG9tOiAxMDAwMDAwLFxuICAgICAgICAgICAgICAgIHJpZ2h0OiAxMDAwMDAwXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICB9XG5cbiAgICAgICAgcmVzdWx0LnByaW1hcnlSZWN0ID0gUmVjdHMudmFsaWRhdGUocHJpbWFyeVJlY3QpO1xuICAgICAgICByZXN1bHQuc2Vjb25kYXJ5UmVjdCA9IFJlY3RzLnZhbGlkYXRlKHNlY29uZGFyeVJlY3QpO1xuXG4gICAgICAgIGNvbnN0IHNlY29uZGFyeUJveCA9IHtcbiAgICAgICAgICAgIGhvcml6b250YWw6IG5ldyBMaW5lKHNlY29uZGFyeVJlY3QubGVmdCwgc2Vjb25kYXJ5UmVjdC5yaWdodCksXG4gICAgICAgICAgICB2ZXJ0aWNhbDogbmV3IExpbmUoc2Vjb25kYXJ5UmVjdC50b3AsIHNlY29uZGFyeVJlY3QuYm90dG9tKVxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IHByaW1hcnlCb3ggPSB7XG4gICAgICAgICAgICBob3Jpem9udGFsOiBuZXcgTGluZShwcmltYXJ5UmVjdC5sZWZ0LCBwcmltYXJ5UmVjdC5yaWdodCksXG4gICAgICAgICAgICB2ZXJ0aWNhbDogbmV3IExpbmUocHJpbWFyeVJlY3QudG9wLCBwcmltYXJ5UmVjdC5ib3R0b20pXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgcmVzdHJpY3Rpb25Cb3ggPSB7XG4gICAgICAgICAgICBob3Jpem9udGFsOiBuZXcgTGluZShyZXN0cmljdGlvblJlY3QubGVmdCwgcmVzdHJpY3Rpb25SZWN0LnJpZ2h0KSxcbiAgICAgICAgICAgIHZlcnRpY2FsOiBuZXcgTGluZShyZXN0cmljdGlvblJlY3QudG9wLCByZXN0cmljdGlvblJlY3QuYm90dG9tKVxuICAgICAgICB9O1xuXG4gICAgICAgIC8vIFRPRE86IGl0IG1pZ2h0IGJlIGJldHRlciB0byBjcmVhdGUgYSBMaW5lU2V0IG9mIHZlcnRpY2FsIGFuZFxuICAgICAgICAvLyBob3Jpem9udGFsIGFuZCB0aGVuIHBhc3MgdGhlbSB0byBhZGp1c3QuXG5cbiAgICAgICAgUHJlY29uZGl0aW9ucy5hc3NlcnRQcmVzZW50KHByaW1hcnlCb3gsIFwicHJpbWFyeUJveFwiKTtcbiAgICAgICAgUHJlY29uZGl0aW9ucy5hc3NlcnRQcmVzZW50KHNlY29uZGFyeUJveCwgXCJzZWNvbmRhcnlCb3hcIik7XG4gICAgICAgIFByZWNvbmRpdGlvbnMuYXNzZXJ0UHJlc2VudChyZXN0cmljdGlvbkJveCwgXCJyZXN0cmljdGlvbkJveFwiKTtcblxuICAgICAgICByZXN1bHQuYWRqdXN0bWVudHMuaG9yaXpvbnRhbFxuICAgICAgICAgICAgPSBEcmFnUmVjdEFkamFjZW5jeUNhbGN1bGF0b3IuYWRqdXN0KHByaW1hcnlCb3guaG9yaXpvbnRhbCwgc2Vjb25kYXJ5Qm94Lmhvcml6b250YWwsIHJlc3RyaWN0aW9uQm94Lmhvcml6b250YWwsIFwieFwiKTtcblxuICAgICAgICByZXN1bHQuYWRqdXN0bWVudHMudmVydGljYWxcbiAgICAgICAgICAgID0gRHJhZ1JlY3RBZGphY2VuY3lDYWxjdWxhdG9yLmFkanVzdChwcmltYXJ5Qm94LnZlcnRpY2FsLCBzZWNvbmRhcnlCb3gudmVydGljYWwsIHJlc3RyaWN0aW9uQm94LnZlcnRpY2FsLCBcInlcIik7XG5cbiAgICAgICAgbGV0IHN1Y2Nlc3NmdWxBZGp1c3RtZW50cyA9IFtyZXN1bHQuYWRqdXN0bWVudHMuaG9yaXpvbnRhbCwgcmVzdWx0LmFkanVzdG1lbnRzLnZlcnRpY2FsXTtcblxuICAgICAgICAvLyB3ZSBvbmx5IHdhbnQgdG8gZmFjdG9yIGluIHdoZXJlIHdlIGFjdHVhbGx5IG92ZXJsYXBwZWQuXG4gICAgICAgIHN1Y2Nlc3NmdWxBZGp1c3RtZW50cyA9IHN1Y2Nlc3NmdWxBZGp1c3RtZW50cy5maWx0ZXIoY3VycmVudCA9PiBjdXJyZW50Lm92ZXJsYXBwZWQgPT09IHRydWUpO1xuXG4gICAgICAgIC8vIG5vdyBzb3J0IHRoZSBhZGp1c3RtZW50cyBzbyB0aGF0IG9uZXMgd2l0aCBhIGxvd2VyIGRlbHRhIGFyZSBmaXJzdC5cbiAgICAgICAgc3VjY2Vzc2Z1bEFkanVzdG1lbnRzID0gc3VjY2Vzc2Z1bEFkanVzdG1lbnRzLnNvcnQoKGFkajAsIGFkajEpID0+IGFkajAuZGVsdGEgLSBhZGoxLmRlbHRhKTtcblxuICAgICAgICBpZiAoc3VjY2Vzc2Z1bEFkanVzdG1lbnRzLmxlbmd0aCA+PSAxKSB7XG4gICAgICAgICAgICByZXN1bHQuYWRqdXN0bWVudCA9IHN1Y2Nlc3NmdWxBZGp1c3RtZW50c1swXTtcbiAgICAgICAgICAgIHJlc3VsdC5hZGp1c3RlZFJlY3QgPSByZXN1bHQuYWRqdXN0bWVudC5hZGp1c3RSZWN0KHByaW1hcnlSZWN0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGp1c3QgdGhlIGxpbmUgYW5kIHJldHVybiB0aGUgcmVxdWlyZWQgYWRqdXN0bWVudCwgb3IgbnVsbCBpZiBub1xuICAgICAqIGFkanVzdG1lbnQgaXMgbmVlZGVkLlxuICAgICAqXG4gICAgICovXG4gICAgcHVibGljIHN0YXRpYyBhZGp1c3QocHJpbWFyeUxpbmU6IExpbmUsIHNlY29uZGFyeUxpbmU6IExpbmUsIHJlc3RyaWN0aW9uTGluZTogTGluZSwgYXhpczogJ3gnIHwgJ3knKSB7XG5cbiAgICAgICAgLy8gdGhlcmUgd2VyZSBubyBtYXRjaGVzLlxuICAgICAgICBjb25zdCBub25lID0gbmV3IExpbmVBZGp1c3RtZW50KHtcbiAgICAgICAgICAgIGF4aXMsXG4gICAgICAgICAgICBvdmVybGFwcGVkOiBmYWxzZSxcbiAgICAgICAgICAgIHN0YXJ0OiBwcmltYXJ5TGluZS5zdGFydCxcbiAgICAgICAgICAgIHNuYXBwZWQ6IG51bGxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgbGV0IHJlc3VsdCA9IG5vbmU7XG5cbiAgICAgICAgaWYgKHNlY29uZGFyeUxpbmUub3ZlcmxhcHMocHJpbWFyeUxpbmUpIHx8IHByaW1hcnlMaW5lLm92ZXJsYXBzKHNlY29uZGFyeUxpbmUpKSB7XG5cbiAgICAgICAgICAgIGxldCByZXN1bHRzID0gW107XG5cbiAgICAgICAgICAgIHJlc3VsdHMucHVzaChMaW5lQWRqdXN0bWVudC5jcmVhdGUoe1xuICAgICAgICAgICAgICAgIGF4aXMsXG4gICAgICAgICAgICAgICAgc3RhcnQ6IHNlY29uZGFyeUxpbmUuZW5kLFxuICAgICAgICAgICAgICAgIHByZXZpb3VzOiBwcmltYXJ5TGluZS5zdGFydCxcbiAgICAgICAgICAgICAgICBzbmFwcGVkOiBcIkFGVEVSXCJcbiAgICAgICAgICAgIH0pKTtcblxuICAgICAgICAgICAgcmVzdWx0cy5wdXNoKExpbmVBZGp1c3RtZW50LmNyZWF0ZSh7XG4gICAgICAgICAgICAgICAgYXhpcyxcbiAgICAgICAgICAgICAgICBzdGFydDogc2Vjb25kYXJ5TGluZS5zdGFydCAtIHByaW1hcnlMaW5lLndpZHRoLFxuICAgICAgICAgICAgICAgIHByZXZpb3VzOiBwcmltYXJ5TGluZS5zdGFydCxcbiAgICAgICAgICAgICAgICBzbmFwcGVkOiBcIkJFRk9SRVwiXG4gICAgICAgICAgICB9KSk7XG5cbiAgICAgICAgICAgIC8vIGZpbHRlciBvdXQgcmVzdWx0cyB0aGF0IHdvdWxkIGJlIGludmFsaWQgZHVlIHRvIHRoZSByZXN0cmljdGlvblxuICAgICAgICAgICAgLy8gbGluZS5cbiAgICAgICAgICAgIHJlc3VsdHMgPSByZXN1bHRzLmZpbHRlciggcmVzdWx0ID0+IHtcblxuICAgICAgICAgICAgICAgIGlmIChyZXN1bHQuc3RhcnQgPCByZXN0cmljdGlvbkxpbmUuc3RhcnQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmICgocmVzdWx0LnN0YXJ0ICsgcHJpbWFyeUxpbmUud2lkdGgpID4gcmVzdHJpY3Rpb25MaW5lLmVuZCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5zb3J0KChyMCwgcjEpID0+IHIwLmRlbHRhIC0gcjEuZGVsdGEpO1xuXG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhgREVCVUc6IHJlc3VsdHMgZm9yICR7YXhpc30gYXhpczogYCArXG4gICAgICAgICAgICAvLyBKU09OLnN0cmluZ2lmeShyZXN1bHRzLCBudWxsLCBcIiAgXCIpKTtcblxuICAgICAgICAgICAgaWYgKHJlc3VsdHMubGVuZ3RoID4gMCApIHtcbiAgICAgICAgICAgICAgICByZXN1bHQgPSByZXN1bHRzWzBdO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH1cblxuICAgICAgICAvLyBjb25zb2xlLmxvZyhgREVCVUc6IEZpbmFsIHJlc3VsdCBmb3IgJHtheGlzfSBheGlzOiBgICtcbiAgICAgICAgLy8gSlNPTi5zdHJpbmdpZnkocmVzdWx0LCBudWxsLCBcIiAgXCIpKTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuXG4gICAgfVxuXG59XG4iXX0=